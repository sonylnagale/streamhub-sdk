<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="/src/css/style.css">
    <style>
    @import (reference) "./variables";

    @charset "UTF-8";
    
    @font-face {
      font-family: "fycons";
      src:url("fycons.eot");
      src:url("fycons.eot?#iefix") format("embedded-opentype"),
        url("fycons.woff") format("woff"),
        url("fycons.ttf") format("truetype"),
        url("fycons.svg#fycons") format("svg");
      font-weight: normal;
      font-style: normal;
    }
    
    [data-icon]:before,
    [class^="fycon-"]:before,
    [class*=" fycon-"]:before {
      font-family: "fycons" !important;
      font-style: normal !important;
      font-weight: normal !important;
      font-variant: normal !important;
      text-transform: none !important;
      speak: none;
      line-height: inherit;
      display: inline-block;
      vertical-align: middle;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    .btn, .btn-lg, .btn-sm {
      [class^="fycon-"]:before,
      [class*=" fycon-"]:before {
        margin-top: -2px;
      }
    }
    
    .fycon-composer-photo:before {
      content: "\e022";
    }

    #listView {
        width:500px;
    }
    
    .lf-btn {
        display: inline-block;
        margin-bottom: 0;
        font-weight: 500;
        text-align: center;
        vertical-align: middle;
        cursor: pointer;
        background-image: none;
        border: 1px solid transparent;
        white-space: nowrap;
        padding: 7px 12px;
        font-size: 14px;
        line-height: 1.428571429;
        border-radius: 4px;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        -o-user-select: none;
        user-select: none;
    }
    
    .lf-upload-btn, .lf .lf-btn-info {
        color: #ffffff;
        background-color: #0f98ec;
        border-color: #0a6aa4;
    }
    
    .lf-upload-btn .fycon-composer-photo {
        font-size: 1.3em;
        padding: 2px;
    }
    
    .lf button {
        -webkit-appearance: button;
        cursor: pointer;
        text-transform: none;
        margin: 0;
    }
    
    button {
        align-items: flex-start;
        text-align: center;
        cursor: default;
        color: buttontext;
        padding: 2px 6px 3px;
        border: 2px outset buttonface;
        border-image-source: initial;
        border-image-slice: initial;
        border-image-width: initial;
        border-image-outset: initial;
        border-image-repeat: initial;
        background-color: buttonface;
        box-sizing: border-box;
        margin: 0em;
        font: -webkit-small-control;
        color: initial;
        letter-spacing: normal;
        word-spacing: normal;
        text-transform: none;
        text-indent: 0px;
        text-shadow: none;
        display: inline-block;
        text-align: start;
    }
    
    .lf * {
        box-sizing: border-box;
    }
    </style>
    <script type="text/javascript" src="//platform.twitter.com/widgets.js"></script>
</head>
    <body class="lf">
        <!--iframe id="picker" style="width:560px;height:432px;"></iframe><br>
        <input type="filepicker" data-fp-container="picker" name="myName"/><br-->
        <button type="filepicker" id="upload" data-fp-container="picker">Post Your Photo <i class="fycon-composer-photo"></i></button><br>
        <form id="write-form">
            <p>Content body:
                <textarea name="body"></textarea>
            </p>
            <p>or Tweet ID: <input name="tweet-id" type="text" /></p>
            <p>Token:
                <input type="text" name="lftoken" value="eyJhbGciOiAiSFMyNTYiLCAidHlwIjogIkpXVCJ9.eyJkb21haW4iOiAibGl2ZWZ5cmUuY29tIiwgImV4cGlyZXMiOiAxMzkxOTA1MjEyLjgyMDM4NiwgInVzZXJfaWQiOiAiX3VwMTc3MDQxMSJ9.U5TTVwVqH-_1aHdkWjI6JGTmt1A3IT0Q5pMIveV0U_s" />
            </p>
            <input type="submit" />
        </form>
        <div id="listView"></div>

        <script src="../../lib/cajon/cajon.js" type="text/javascript"></script>
        <script src="/requirejs.conf.js" type="text/javascript"></script>
        <script>
            requirejs({
                baseUrl: "/"
            });
        </script>
        <script>
        require([
            'streamhub-sdk/content/views/content-list-view',
            'streamhub-sdk/collection',
            'streamhub-sdk/content',
            'streamhub-sdk/content/content-view-factory',
            'streamhub-sdk/util',
            'streamhub-sdk/auth',
            'streamhub-sdk/upload/button'
        ],function (ListView, Collection, Content, ContentViewFactory, Util, Auth, Button) {
            /* var opts = {
                "network": "labs-t402.fyre.co",
                "siteId": "303827",
                "articleId": "xbox-0",
                "environment": "t402.livefyre.com"
            }; */
            var opts = {/* TESTING OPTS */
                    "network": "livefyre.com",
                    "siteId": "290596",
                    "articleId": "177",
                    "environment": "qa-ext.livefyre.com"
                };
            
            var listView = window.view = new ListView({
                initial: 3,
                showMore: 2,
                el: document.getElementById("listView")
            });

            var collection = window.collection =  new Collection(opts);
            var onwriteFn = collection._writableState.onwrite;
            collection._writableState.onwrite = function(err) {
                onwriteFn(err);
                if (err === 'FORBIDDEN') {
                    if (Auth.getToken()) {
                        throw 'User is not permitted to write content to this collection';
                    }
                    //User needs to authenticate
                    //TODO (joao) authenticate user
                    
                    
                    //TODO (joao) retry the upload?
                }
            }
            
            collection.pipe(listView);
            
            var archive = window.archive = collection.createArchive();
            
            archive.pipe(listView.more);
            
            Auth.setToken($('#write-form').serializeArray()[2].value);
            
            var $writeForm = $('#write-form');
            $writeForm.submit(function (e) {
                e.preventDefault();

                var formArray = $writeForm.serializeArray(),
                    body = formArray[0].value,
                    tweetId = formArray[1].value,
                    lftoken = formArray[2].value,
                    contentToWrite;
                if (body) {
                    contentToWrite = new Content(body);
                } else if (tweetId) {
                    contentToWrite = { tweetId: tweetId };
                }
                if (lftoken) {
                    Auth.setToken(lftoken);
                }
                /* if ( ! Auth.getToken() || ! contentToWrite) {
                    alert("Cant write. Not enough info");
                    return;
                } */
                collection.write(contentToWrite);
                //listView.write(contentToWrite);
            });
            
            var button = window.button = new Button(null, collection, {
                el: document.getElementById("upload")
            });
            
        });
        </script>
    </body>
</html>
