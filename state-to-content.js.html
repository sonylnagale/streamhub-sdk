<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<title>streamhub-sdk Source: content/state-to-content.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	
	<link type="text/css" rel="stylesheet" href="styles/site.cosmo.css">
	
</head>

<body>
<div class="container-fluid">
	<div class="navbar navbar-fixed-top ">
		<div class="navbar-inner">
			<a class="brand" href="index.html">streamhub-sdk</a>
			<ul class="nav">
				
				<li class="dropdown">
					<a href="modules.list.html" class="dropdown-toggle" data-toggle="dropdown">Modules<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="livefyre-auth-client.html">streamhub-sdk/clients/livefyre-auth-client</a>
						</li>
						
						<li>
							<a href="bootstrap-client.html">streamhub-sdk/collection/clients/bootstrap-client</a>
						</li>
						
						<li>
							<a href="stream-client.html">streamhub-sdk/collection/clients/stream-client</a>
						</li>
						
						<li>
							<a href="write-client.html">streamhub-sdk/collection/clients/write-client</a>
						</li>
						
						<li>
							<a href="storage.html">streamhub-sdk/storage</a>
						</li>
						
						<li>
							<a href="util.html">streamhub-sdk/util</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="content.html">streamhub-sdk/content</a>
						</li>
						
						<li>
							<a href="content-view-factory.html">streamhub-sdk/content-view-factory</a>
						</li>
						
						<li>
							<a href="livefyre-content.html">streamhub-sdk/content/types/livefyre-content</a>
						</li>
						
						<li>
							<a href="livefyre-facebook-content.html">streamhub-sdk/content/types/livefyre-facebook-content</a>
						</li>
						
						<li>
							<a href="livefyre-instagram-content.html">streamhub-sdk/content/types/livefyre-instagram-content</a>
						</li>
						
						<li>
							<a href="livefyre-oembed.html">streamhub-sdk/content/types/livefyre-oembed</a>
						</li>
						
						<li>
							<a href="livefyre-twitter-content.html">streamhub-sdk/content/types/livefyre-twitter-content</a>
						</li>
						
						<li>
							<a href="oembed.html">streamhub-sdk/content/types/oembed</a>
						</li>
						
						<li>
							<a href="twitter-content.html">streamhub-sdk/content/types/twitter-content</a>
						</li>
						
						<li>
							<a href="content-view.html">streamhub-sdk/content/views/content-view</a>
						</li>
						
						<li>
							<a href="facebook-content-view.html">streamhub-sdk/content/views/facebook-content-view</a>
						</li>
						
						<li>
							<a href="instagram-content-view.html">streamhub-sdk/content/views/instagram-content-view</a>
						</li>
						
						<li>
							<a href="oembed-view.html">streamhub-sdk/content/views/oembed-view</a>
						</li>
						
						<li>
							<a href="twitter-content-view.html">streamhub-sdk/content/views/twitter-content-view</a>
						</li>
						
						<li>
							<a href="modal.html">streamhub-sdk/modal</a>
						</li>
						
						<li>
							<a href="attachment-gallery-modal.html">streamhub-sdk/modal/views/attachment-gallery-modal</a>
						</li>
						
						<li>
							<a href="view.html">streamhub-sdk/view</a>
						</li>
						
						<li>
							<a href="attachment-list-view.html">streamhub-sdk/views/attachment-list-view</a>
						</li>
						
						<li>
							<a href="gallery-attachment-list-view.html">streamhub-sdk/views/gallery-attachment-list-view</a>
						</li>
						
						<li>
							<a href="list-view.html">streamhub-sdk/views/list-view</a>
						</li>
						
						<li>
							<a href="tiled-attachment-list-view.html">streamhub-sdk/views/tiled-attachment-list-view</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="events.list.html" class="dropdown-toggle" data-toggle="dropdown">Events<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="ContentView_removeContentView.html#event:hub">hub</a>
						</li>
						
						<li>
							<a href="GalleryAttachmentListView_hideModal.html#event:hub">hub</a>
						</li>
						
						<li>
							<a href="OembedView_imageError.html#event:hub">hub</a>
						</li>
						
						<li>
							<a href="OembedView_imageLoaded.html#event:hub">hub</a>
						</li>
						
						<li>
							<a href="TiledAttachmentListView_focusContent.html#event:hub">hub</a>
						</li>
						

					</ul>
				</li>
				
			</ul>
		</div>
	</div>

	<div class="row-fluid">

		
			<div class="span12">
				
				<div id="main">
					


		<h1 class="page-title">Source: content/state-to-content.js</h1>
    
    <section>
        <article>
            <pre class="sunlight-highlight-javascript linenums">define([
    'streamhub-sdk/content/types/livefyre-content',
    'streamhub-sdk/content/types/livefyre-twitter-content',
    'streamhub-sdk/content/types/livefyre-facebook-content',
    'streamhub-sdk/content/types/oembed',
    'streamhub-sdk/content/types/livefyre-oembed',
    'streamhub-sdk/content/types/livefyre-instagram-content',
    'streamhub-sdk/storage',
    'streamhub-sdk/debug',
    'stream/transform',
    'inherits'
], function (LivefyreContent, LivefyreTwitterContent, LivefyreFacebookContent,
Oembed, LivefyreOembed, LivefyreInstagramContent, Storage, debug, Transform,
inherits) {
    'use strict';


    var log = debug('streamhub-sdk/content/state-to-content');


    /**
     * An Object that transforms state objects from Livefyre APIs
     * into streamhub-sdk Content instances
     * @param authors {object} A mapping of authorIds to author information
     * @param [replies=false] {boolean} Whether to read out reply Content
     */
    var StateToContent = function (opts) {
        opts = opts || {};
        this._authors = opts.authors || {};
        this._replies = opts.replies;
        Transform.call(this, opts);
    };

    inherits(StateToContent, Transform);


    StateToContent.prototype._transform = function (state, done) {
        var contents;
        try {
            contents = StateToContent.transform(state, this._authors, {
                replies: this._replies
            });
        } catch (err) {
            this.emit('error transforming state-to-content', err);
            log('StateToContent.transform threw', err);
        }
        if (contents && contents.length) {
            this.push.apply(this, contents);
        }
        done();
    };


    /**
     * Creates the correct content type given the supplied "state".
     * @param state {Object} The livefyre content "state" as received by the
     *     client.
     * @return {LivefyreContent[]} An Array containing a Content that represents
     *     the passed state, if it was top-level. If opts.replies, then any
     *     reply Content that was transformed will be returned
     *     (including potentially many descendants)
     */
    StateToContent.transform = function (state, authors, opts) {
        opts = opts || {};
        var isPublic = (typeof state.vis === 'undefined') || (state.vis === 1),
            isReply = state.content.parentId,
            type = StateToContent.enums.type[state.type],
            isAttachment = ('OEMBED' === type),
            isContent = ('CONTENT' === type),
            childStates = state.childContent || [],
            content,
            childContent = [],
            descendantContent = [];

        if ( ! (isAttachment || isContent)) {
            return;
        }

        content = StateToContent._createContent(state, authors);

        // Store content with IDs in case we later get
        // replies or attachments targeting it
        if (content && content.id) {
            Storage.set(content.id, content);
            childContent = Storage.get('children_'+content.id) || [];
        }

        // Get child states (replies and attachments)
        childStates = state.childContent || [];
        // Transform child states (replies and attachments)
        // This will put them in Storage
        for (var i=0, numChildren=childStates.length; i &lt; numChildren; i++) {
            var thisReplyAndDescendants = this.transform(childStates[i], authors, opts);
            descendantContent.push.apply(descendantContent, thisReplyAndDescendants || []);
        }

        // Add any children that are awaiting the new content
        if (childContent.length) {
            this._addChildren(content, childContent);
        }

        // At this point, all content and children (recursively)
        // Are stored by ID
        // Attach attachments to their target, or store for later
        if (isAttachment) {
            this._attachOrStore(content, state.content.targetId);
        }
        // Add replies to their parent, or store for later
        if (isReply) {
            this._addReplyOrStore(content, state.content.parentId);
        }

        // Never return non-Content items or non-public items
        // But note, this is at the end of the recursive function,
        // so these items are still walked/processed, just not returned
        if ( ! isContent || ! isPublic) {
            return;
        }

        // Don't return replies if not explicitly specified
        if (isReply && ! opts.replies) {
            return;
        }

        if (opts.replies) {
            return [content].concat(descendantContent);
        }
        return [content];
    };


    StateToContent._addChildren = function (content, children) {
        var child;
        for (var i=0, numChildren=children.length; i &lt; numChildren; i++) {
            child = children[i];
            if (child instanceof Oembed) {
                content.addAttachment(child);
            } else if (child instanceof LivefyreContent) {
                content.addReply(child);
            }
        }
    };


    StateToContent._createContent = function (state, authors) {
        var sourceName = StateToContent.enums.source[state.source],
            ContentType;

        state.author = authors && authors[state.content.authorId];

        if ('OEMBED' === StateToContent.enums.type[state.type]) {
            return new LivefyreOembed(state);
        } else if (sourceName === 'twitter') {
            return new LivefyreTwitterContent(state);
        } else if (sourceName === 'facebook') {
            return new LivefyreFacebookContent(state);
        } else if (sourceName === 'feed') {
            ContentType = LivefyreContent;
            // Use specific Content type for states from instagram RSS feeds
            if (isInstagramState(state)) {
                ContentType = LivefyreInstagramContent;
            }
            return new ContentType(state);
        } else if (sourceName === 'livefyre') {
            return new LivefyreContent(state);
        }
    };


    function isInstagramState (state) {
        var pattern = /\/\/instagram\.com/i;
        try {
            return state.content.feedEntry.channelId.match(pattern);
        } catch (err) {
            return false;
        }
    }


    StateToContent._attachOrStore = function (attachment, targetId) {
        var target = Storage.get(targetId);
        if (target) {
            log('attaching attachment', arguments);
            target.addAttachment(attachment);
        } else {
            log('storing attachment', arguments);
            this._storeChild(attachment, targetId);
        }
    };


    StateToContent._addReplyOrStore = function (reply, parentId) {
        var parent = Storage.get(parentId);
        if (parent) {
            log('adding reply', arguments);
            parent.addReply(reply);
        } else {
            log('storing reply', arguments);
            this._storeChild(reply, parentId);
        }
    };


    StateToContent._storeChild = function (child, parentId) {
        var childrenKey = 'children_' + parentId,
            children = Storage.get(childrenKey) || [];
        children.push(child);
        Storage.set(childrenKey, children);
    };


    StateToContent.enums = {};


    StateToContent.enums.source = LivefyreContent.SOURCES;


     /**
     * The StreamHub APIs use enumerations to define
     * the type of message sent down the wire. All types
     * should be in this enumeration.
     * @enum types
     * @property {string} types.CONTENT - The good stuff. Juicy Content
     * like comments
     * @property {string} types.OPINE - A user's opinion or something
     * @property {string} types.SHARE - TODO: I don't know yet.
     * @property {string} types.OEMBED - A new attachment
     */
    StateToContent.enums.type = [
        'CONTENT',
        'OPINE',
        'SHARE',
        'OEMBED'
    ];


    StateToContent.Storage = Storage;
    return StateToContent;
});</pre>
        </article>
    </section>





				</div>

				<div class="clearfix"></div>
				<footer>
					
					<style>pre { color: black; } .nav-pills > li > a { background-color: white; } #toc .toc-active { background-color: black; } .navbar .dropdown-menu { width: auto; } #toc { border: 0; } </style> <script>(function () { document.addEventListener('DOMContentLoaded', function(event) {    var $pageTitle = $('.page-title');    if ($pageTitle.html() === 'Index') {        $pageTitle.hide();    }}); }());</script><script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');  ga('create', 'UA-38120262-13', 'livefyre.github.io'); ga('send', 'pageview');</script>
					<br />
					
					
		<span class="copyright">
		Â© 2013, streamhub-sdk contributors.
		</span>
					<br />
					
		<span class="jsdoc-message">
		Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-dev</a>
		on Wed Oct 16 2013 02:14:07 GMT-0700 (PDT) using the <a href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
		</span>
				</footer>
			</div>

			
			<br clear="both">
		</div>

	</div>
	<script src="scripts/sunlight.js"></script>
	<script src="scripts/sunlight.javascript.js"></script>
	<script src="scripts/sunlight-plugin.doclinks.js"></script>
	<script src="scripts/sunlight-plugin.linenumbers.js"></script>
	<script src="scripts/sunlight-plugin.menu.js"></script>
	<script src="scripts/jquery.min.js"></script>
	<script src="scripts/jquery.scrollTo.js"></script>
	<script src="scripts/jquery.localScroll.js"></script>
	<script src="scripts/bootstrap-dropdown.js"></script>
	<script src="scripts/toc.js"></script>


	<script>  Sunlight.highlightAll({lineNumbers:true,  showMenu: true, enableDoclinks :true}); </script>

	<script>
		$( function () {
			$( "#toc" ).toc( {
				selectors   : "h1,h2,h3,h4",
				showAndHide : false,
				scrollTo    : 60
			} );
			$( "#toc>ul" ).addClass( "nav nav-pills nav-stacked" );
			$( "#main span[id^='toc']" ).addClass( "toc-shim" );

		} );
	</script>

	

</body>
</html>
